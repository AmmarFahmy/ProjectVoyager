<html>
    <head>
        <title>Voyager File Manager</title>
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
        <link rel="stylesheet" href="sift.css"/>
    </head>
    <body onload="goTo(home, 0)" class="dark matte">
        <div id="context">
            <table id="context-table" class="itemlist hover-enabled">

            </table>
        </div>
        <div id="titlewrapper">
            <div id="titlebar">
                <div id="bck_btn" class="topbtn" onclick="goTo(siftlib.goBack(), 0)"><img src="./bin/img/bck.png"/></div>
                <div id="fwd_btn" class="topbtn" onclick="goTo(siftlib.goForth(), 0)"><img src="./bin/img/fwd.png"/></div>
                <div id="titleplace">
                    <p>Voyager File Manager (Beta)</p>
                </div>
                <div id="min_btn" class="topbtn" onclick="win.minimize()"><img src="./bin/img/min.png"/></div>
                <div id="rsz_btn" class="topbtn" onclick="resizeWin()"><img src="./bin/img/max.png"/></div>
                <div id="cls_btn" class="topbtn" onclick="win.close()"><img src="./bin/img/cls.png"/></div>
            </div>
        </div>
        <div id="pathboxcontainer">
        <div id="mn_btn" class="topbtn" onclick=""><img src="./bin/img/mn.png"/></div>
        <div id="up_btn" class="topbtn" onclick="goTo(path.parse(pathString).dir, 1)"><img src="./bin/img/up.png"/></div>
        <input type="text" id="pathbox" onkeydown="textFieldKeyHandler(event)"></input>
        <div id="hm_btn" class="topbtn" onclick="goTo(home, 1)"><img src="./bin/img/hm.png"/></div>
        <div id="rf_btn" class="topbtn" onclick="goTo(document.getElementById('pathbox').value, 0)"><img src="./bin/img/rf.png"/></div>
        <div id="go_btn" class="topbtn" onclick="goTo(document.getElementById('pathbox').value, 1)"><img src="./bin/img/fwd.png"/></div>
        </div>
            <div id="content-box-holder">
                <table class="itemlist hover-enabled" id="filelist">

                </table>
            </div>
        <script>
            const os = require('os');
            const path = require('path');
            const { ipcRenderer, shell } = require('electron');
            const win = require('electron').remote.getCurrentWindow();
            const siftlib = require('./siftlib');
            const fs = require('fs');
            var home = os.homedir().replace(/\\/g, '/');
            var pathString = home;
            var maxflag = 0;
            var filelist = document.getElementById('filelist');
            var cmenu = document.getElementById('context');

            window.addEventListener("click", (evt) => {
                evt.preventDefault();
                if(cmenu.classList.contains('show')){
                    cmenu.classList.remove('show');
                    filelist.classList.add('hover-enabled');
                }
            });

            document.addEventListener('contextmenu', (evt) => {
                if (evt.target.parentElement.classList.contains('item')){
                    if(!evt.target.parentElement.classList.contains('select')){
                        selectItem(evt.target.parentElement, 1);
                    }
                    cmenu.children[0].innerHTML = siftlib.popCMenu(evt, pathString)
                }
                cmenu.style.top = evt.clientY;
                cmenu.style.left = evt.clientX;
                filelist.classList.remove('hover-enabled');
                cmenu.classList.add('show');
            })

            function selectItem(item, slflag){
                selected = document.getElementsByClassName('select');
                if(item.classList.contains('select') && slflag === 0){
                    //if the flag is zero, we are trying to toggle the checkbox
                    item.classList.remove('select');
                    item.children[0].children[0].src='./bin/img/chk0.png';
                } else {
                    //if the flag is 1, we want to deselect all other currently selected elements
                    if (slflag === 1){
                        Object.entries(selected).forEach((entry) => {
                        entry[1].classList.remove('select');
                            if(entry[1].attributes.type.value === "folder"){
                                    entry[1].children[0].children[0].src='./bin/img/fld.png';
                            }
                            if(entry[1].attributes.type.value === "file"){
                                    entry[1].children[0].children[0].src='./bin/img/fil.png';
                            }
                        });
                    }
                    item.children[0].children[0].src='./bin/img/chk1.png';
                    item.classList.add('select');
                }
            }

            function render(args){
                if (args.type === 'folder'){
                    document.getElementById('filelist').innerHTML = args.pagedata;
                    pathString = args.pathString;
                    document.getElementById('pathbox').value = args.pathString;
                } else {
                    console.log(args.pathString);
                    shell.openItem(args.pathString);
                }
            }

            function textFieldKeyHandler(event) {
                if (event.key === 'Enter') {
                    goTo(document.getElementById('pathbox').value, 1);
                } else {

                }
            };

        function goTo(pathString, navflag) {
            //error handle locally
            var stats = fs.stat(pathString, '', (err, stats) => {
                if (err) {
                    console.log(err.code); 
                    //what's the issue?
                    switch (err.code) {
                        case ('EPERM'): {
                            notify('Your system restricts "' + pathString + '".');
                            break;
                        }
                        case ('ENOENT'): {
                            notify(pathString + ' does not exist in the current filesystem.');
                            break;
                        }
                        case ('EACCES'): {
                            notify('You do not have the account permissions to access "' + pathString + '".');
                            break;
                        }
                        default: {
                            notify('Whoops! I got something wrong, here. Try that again.')
                            break;
                        }
                    }
                } else {
                    //if everything is okay...
                    render(siftlib.sift(pathString, navflag));
                }
            })
        };
    function notify(message){
        ipcRenderer.send('ntf', message);
    }
    win.on('closed', () => {
        win = null;
    })
    win.on('maximize', (evt) => {
        document.getElementById('rsz_btn').innerHTML='<img src="./bin/img/res.png"/>';
    })
    win.on('resize', (evt) => {
        if (win.isMaximized() === false) {
            document.getElementById('rsz_btn').innerHTML='<img src="./bin/img/max.png"/>';
        }
    })
    function resizeWin(){
        if (maxflag === 0) {
            maxflag = 1;
            win.maximize();
        } else {
            maxflag = 0;
            win.restore();
        }
    }
        </script>
    </body>
</html>
